// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User role enum
enum UserRole {
  STUDENT
  MENTOR
  TEACHER
}

// Submission status enum
enum SubmissionStatus {
  PENDING
  IN_REVIEW
  COMPLETED
}

// User table for storing role and other user-specific data
model User {
  id                 String   @id // Clerk user ID
  email              String?  // User's email from Clerk
  role               UserRole @default(STUDENT)
  approved           Boolean  @default(false) // Admin approval required for new users
  onboardingComplete Boolean  @default(false)
  baseToneHz         Float?   // Udhaatha - base tone in Hz from OM recording
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([role])
  @@index([approved])
  @@index([onboardingComplete])
  @@index([email])
}

// User stats aggregation table
model UserStats {
  id             String   @id @default(uuid())
  userId         String   @unique // Clerk user ID
  totalPractices Int      @default(0)
  averageScore   Float    @default(0)
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  totalTimeMs    Int      @default(0) // Total time in milliseconds
  lastPracticed  DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
}

// Mantra definition
model Mantra {
  id                 String            @id @default(uuid())
  title              String
  category           String
  difficulty         String
  verses             Int
  duration           String
  audioUrl           String?
  practitionersCount Int               @default(0) // Number of people currently practicing
  likesCount         Int               @default(0) // Total number of likes
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  practices          Practice[]
  mantraProgress     MantraProgress[]
  likes              MantraLike[]
}

// Track which users liked which mantras
model MantraLike {
  id        String   @id @default(uuid())
  userId    String   // Clerk user ID
  mantraId  String
  createdAt DateTime @default(now())

  mantra    Mantra   @relation(fields: [mantraId], references: [id], onDelete: Cascade)

  @@unique([userId, mantraId])
  @@index([userId])
  @@index([mantraId])
}

// Practice session
model Practice {
  id         String      @id @default(uuid())
  userId     String      // Clerk user ID
  mantraId   String
  date       DateTime    @default(now())
  durationMs Int         // Duration in milliseconds
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  mantra     Mantra      @relation(fields: [mantraId], references: [id], onDelete: Cascade)
  recordings Recording[]

  @@index([userId])
  @@index([mantraId])
  @@index([userId, mantraId])
}

// Recording for a practice session
model Recording {
  id                  String   @id @default(uuid())
  practiceId          String
  audioUrl            String   // Supabase storage URL
  score               Float
  submittedForReview  Boolean  @default(false)
  reviewStatus        String   @default("not-submitted") // not-submitted, under-review, reviewed
  mentorRemarks       String?
  detailedFeedback    Json?    // Detailed pronunciation and swara mistakes
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  practice            Practice       @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  submission          Submission?
  alignmentWords      AlignmentWord[]

  @@index([practiceId])
}

// Per-mantra progress tracking
model MantraProgress {
  id             String   @id @default(uuid())
  userId         String   // Clerk user ID
  mantraId       String
  totalPractices Int      @default(0)
  averageScore   Float    @default(0)
  lastPracticed  DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  mantra         Mantra   @relation(fields: [mantraId], references: [id], onDelete: Cascade)

  @@unique([userId, mantraId])
  @@index([userId])
  @@index([mantraId])
}

// Submission for mentor review
model Submission {
  id             String           @id @default(uuid())
  recordingId    String           @unique
  studentId      String           // Clerk user ID of student
  mentorId       String?          // Clerk user ID of assigned mentor (null = unassigned)
  status         SubmissionStatus @default(PENDING)
  submittedAt    DateTime         @default(now())
  reviewedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  recording      Recording        @relation(fields: [recordingId], references: [id], onDelete: Cascade)
  feedbacks      Feedback[]

  @@index([studentId])
  @@index([mentorId])
  @@index([status])
  @@index([submittedAt])
}

// Feedback given by mentor on a submission
model Feedback {
  id              String   @id @default(uuid())
  submissionId    String
  mentorId        String   // Clerk user ID of mentor
  overallRemarks  String   // Markdown text with overall feedback
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  submission      Submission       @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  markers         FeedbackMarker[]

  @@index([submissionId])
  @@index([mentorId])
}

// Timestamp-based feedback markers
model FeedbackMarker {
  id         String   @id @default(uuid())
  feedbackId String
  timestamp  Float    // Time in seconds in the audio
  comment    String   // Feedback comment at this timestamp
  createdAt  DateTime @default(now())

  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
  @@index([timestamp])
}

// Word-level alignment data from Whisper
model AlignmentWord {
  id         String   @id @default(uuid())
  recordingId String
  word       String   // The recognized word
  startTime  Float    // Start time in seconds
  endTime    Float    // End time in seconds
  confidence Float    // Confidence score from Whisper
  createdAt  DateTime @default(now())

  recording  Recording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  @@index([recordingId])
  @@index([startTime])
}
